При обновлении торрентов [emupdate](/emupdate) умеет посылать оповещения. Для включения этой возможности вам нужно [настроить](/config) соответствующие плагины в секции `confetti`. Ниже приведен пример для уведомлений по почте (через [внешний почтовый сервер](https://yandex.ru/support/mail/mail-clients.xml)), а также через [Pushover](https://pushover.net/):

```yaml
confetti:
    email:
        to: yarr@example.com
        server: smtp.yandex.ru
        ssl: true
        user: emonodaserver
        passwd: secretword
        sender: emonodaserver@yandex.ru

	pushover:
        api_key: xxxxxxxxxxxxxxxxxxxx
        user_key: yyyyyyyyyyyyyyyyyyyy
```

Плагины отправляют оповещения в разных ситуациях и при различных событиях, происходящих с торрентами. Самый простой вариант - торрент обновился, добавилась новая серия вашего сериала, и [emupdate](/emupdate) поставил ее на закачку. Это событие называется `affected`, и кроме него существуют еще несколько типов, относящихся, в основном, к обработке ошибок при обновлении торрентов.

Полный список приведен в таблице ниже:

| Статус | Описание |
|--------|----------|
| `invalid` | Торрент с некорректным форматом данных (битые файлы) |
| `not_in_client` | Торрент не отслеживается клиентом |
| `unknown` | Неизвестный трекер, который не поддерживается **Emonoda** |
| `affected` | Торрент обновился |
| `tracker_error` | Ошибка обновления торрента из-за некорректного ответа трекера. Вероятно, раздача могла быть удалена и ее стоит заменить на другую |
| `unhandled_error` | Непредвиденная ошибка при обработке торрента. Рекомендуется просмотреть результат работы [emupdate](/emupdate), чтобы узнать, какое произошло исключение |

То, какие оповещения должны отправляться соответствующим плагином, настраивается параметром `confetti/<plugin>/statuses` (при его наличии). Например, если значение этого параметра равно `[affected, tracker_error]`, то оповещения будут отправляться при изменениях торрента и при ошибках его обновления (скажем, если вдруг раздача была удалена с трекера).

Следует отметить, что [emupdate](/emupdate) не хранит истории сообщений, и поэтому, если при указанной выше настройке у вас появится раздача, вызывающая ошибку при обработке, вы будете получать оповещения **каждый раз** при запуске [emupdate](/emupdate), пока не удалите или не замените ее.

!!! advice
    Такое поведение может быть неприемлимым, если вы поставили [emupdate](/emupdate) на исполниение в кроне каждый час. Вряд ли вам захочется получать спам-сообщения в Telegram о том, что какая-то раздача удалилась каждый час, пока вы не разберетесь с этой проблемой. Однако информация о том, что с раздачей что-то не так, может быть полезной, и в таком случае можно сделать следующее:

    * Настроить несколько видов оповещений. Например, в для Telegram вы можете сделать настройку `confetti/telegram/statuses=[affected]`, а для электропочты - `confetti/email/statuses=[invalid, not_in_client, tracker_error, unhandled_error, affected]`. Тогда Telegram будут падать только оповещения об обновлениях, а в почту - все возникающие события. Зафильтровав почту, вы можете отправить эти письма в отдельную папку и просмотреть потом в удобное время.

    * Перенаправить результат работы [emupdate](/emupdate) в лог.

!!! warning
    По умолчанию все плагины, кроме `atom`, настроены на оповещение при любых событиях, кроме `unknown`. Плагин `atom` настроек статусов не имеет и обновляет ленту только при наличии событий типа `affected`.

Большинство плагинов имеют возможность кастомизации шаблонов форматирования оповещений. Используя синтаксис [Mako](http://docs.makotemplates.org/en/latest/syntax.html), вы можете настроить шаблон по своему вкусу, взяв за основу [любой из стандартных](https://github.com/mdevaev/emonoda/tree/master/emonoda/plugins/confetti/templates). Создав свой шаблон, сохраните его где-нибудь в файле и пропишите в конфиге. Например так:

```yaml
confetti:
    email:
        template=/root/emonoda-email.mako
```


***
### Виды оповещений


#### Почта

Включается плагином `email`. По умолчанию плагин настроен на отправку почты через локальный SMTP-релей без SSL на `root@localhost`. Другие параметры со значениями по умолчанию перечислены ниже:

* **`confetti/email/subject='{source} report: you have {affected} new torrents ^_^'`**
    * Тема письма. В фигурных скобках указываются подставляемые параметры: `source` обозначает источник данных (сейчас это всегда `emupdate`), а `affected` показывает количество обновленных торрентов.

* **`confetti/email/template=""`**
    * Путь к Mako-шаблону для форматирования письма. Если не указан, используется встроенный.

* **`confetti/email/statuses=[invalid, not_in_client, tracker_error, unhandled_error, affected]`**
    * Типы сообщений о результатах обновления, которые необходимо отправить (в порядке отправки, кроме `affected`, который всегда идет первым).

* **`confetti/email/to=[root@localhost]`**
    * Адрес получателя (один или список) в `To`.

* **`confetti/email/cc=[]`**
    * Кому отправить копию письма в `CC`.

* **`confetti/email/html=true`**
    * Выбор вида письма. По умолчанию оно форматируется в HTML, иначе отправится в виде плейнтекста.

* **`confetti/email/sender=root@localhost`**
    * Отправитель для поля `From`.

* **`confetti/email/server=localhost`**
    * Адрес SMTP-сервера.

* **`confetti/email/port=0`**
    * Порт подключения серверу. Значение по умолчанию определяется автоматически в зависимости от параметра `confetti/email/ssl`. Используется `25` порт для незащищенного соединения и `465` для SSL.

* **`confetti/email/ssl=false`**
    * Использовать ли SSL для SMTP. Так же влияет на номер порта по умолчанию.

* **`confetti/email/user=""`**
    * Имя пользователя для авторизации на сервере.

* **`confetti/email/passwd=""`**
    * Пароль для авторизации на сервере.

* **`confetti/email/timeout=10.0`**
    * Сетевой таймаут в секундах.

* **`confetti/email/retries=5`**
    * Количество попыток повторной отправки емейлов в случае ошибки сети или сервера.

* **`confetti/email/retries_sleep=1.0`**
    * Пауза в секундах между попытками отправки емейлов.


***
#### Уведомления в Telegram

Включаются плагином `telegram`. Для отправки уведомлений используется [API ботов](https://core.telegram.org/bots/api). Чтобы отправлять себе на телеграм сообщение об обновленных раздачах, вам нужно завести своего собственного бота, получить для него токен и идентификатор чата с пользователем, которому нужно послать оповещение. Это несложно и делается всего в несколько простых шагов:

1. Добавьте в телеграм бота **BotFather** и поздоровайтесь с ним командой `/start`.

2. Скажите ему `/newbot`, а затем в ответ на вопросы введите желаемое символическое имя бота (например, **MySuperServer**, так он будет показываться в контактах) и его юзернейм (например, `my_super_server_bot`). Юзернейм должен обязательно заканчиваться на суффикс `_bot` или `Bot`.

3. Если имена не заняты, **BotFather** выдаст вам токен для вашего бота, похожий на `123456789:ABCDE_Abc1Def234-sdf34HJKhjg33434GH`. В противном случае придумайте другое имя и повторите предыдущий шаг.

4. Полученный токен пропишите в [конфигурационный файл](/config) в секцию `confetti` следующим образом:

        confetti:
            telegram:
                token: 123456789:ABCDE_Abc1Def234-sdf34HJKhjg33434GH

5. Добавьте в контакт-лист своего телеграма вашего нового бота и поздоровайтесь с ним командой `/start`.

6. Запустите команду `emconfetti-tghi`. Она просмотрит список десяти последних сообщений, адресованных боту, и выведет имена пользователей, обращавшихся к нему, вместе с юзернеймами телеграм-пользователей (если они заданы). Команда выведет что-то типа этого:

        $ emconfetti-tghi
        # I: Confetti telegram is ready
        - Chat with user 'cooluser': 12345678

7. Добавьте полученный идентификатор чата (`12345678`) в конфиг. Можно добавлять несколько чатов списком, чтобы уведимить сразу несколько пользователей; они все должны поздороваться с вашим ботом, чтобы вы могли узнать их идентификаторы чатов:

        confetti:
            telegram:
                token: 123456789:ABCDE_Abc1Def234-sdf34HJKhjg33434GH
                chats: [12345678]

8. Все готово! Теперь попробуйте отправить себе тестовое оповещение с помощью `emconfetti-demo -o telegram` и радуйтесь жизни :)

Плагин принимает следующие параметры:

* **`confetti/telegram/token=CHANGE_ME`**
    * Токен бота, полученный от **BotFather**.

* **`confetti/telegram/chats=[]`**
    * Список идентификаторов чатов, в которые нужно отсылать оповещения.

* **`confetti/telegram/template=""`**
    * Путь к mako-шаблону для форматирования сообщений. Если не указан, используется встроенный.

* **`confetti/telegram/statuses=[invalid, not_in_client, tracker_error, unhandled_error, affected]`**
    * Типы сообщений о результатах обновления, которые необходимо отправить (в порядке отправки).

* **`confetti/telegram/proxy_url=""`**
    * Прокси до сервиса. Поддерживаются HTTP-прокси и SOCKS4/5. Этот параметр можно использовать так: `trackers/rutracker.org/proxy_url=socks5://localhost:5000` (вместе с [SOCKS-проксированием по SSH](https://ru.wikibooks.org/wiki/SSH_%D1%82%D1%83%D0%BD%D0%BD%D0%B5%D0%BB%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5)). Формат - `scheme://username:passwd@host:port`. Вместо `scheme` нужно указать `socks4`, `socks5` или `http`.

* **`confetti/telegram/timeout=10.0`**
    * Сетевой таймаут в секундах.

* **`confetti/telegram/retries=5`**
    * Количество попыток повторной отправки оповещений в случае ошибки сети или сервера.

* **`confetti/telegram/retries_sleep=1.0`**
    * Пауза в секундах между попытками отправки оповещений.

* **`confetti/telegram/user_agent=Mozilla/5.0`**
    * Плагин прикидываются браузером при работе с API.


***
#### Push-нотификации на iPhone/Android через Pushover

Включаются плагином `pushover`. Для отправки уведомлений используется [одноименный сервис](https://pushover.net/). Вам нужно установить на телефон или планшет специальное приложение ([iPhone](https://itunes.apple.com/ru/app/pushover-notifications/id506088175), [Android](https://play.google.com/store/apps/details?id=net.superblock.pushover)), зарегистрировать **Emonoda** (по терминологии пушовера "приложение") [тут](https://pushover.net/apps/build), а затем получить ключ для него и для юзера (на главной странице). По этим ключам отправляются уведомления на ваше устройство.

* **`confetti/pushover/api_key=CHANGE_ME`**
    * Ключ приложения.

* **`confetti/pushover/user_key=CHANGE_ME`**
    * Ключ пользователя.

* **`confetti/pushover/devices=[]`**
    * Список устройств пользователя, на которые нужно отправить оповещение. Пустой список - все устройства.

* **`confetti/pushover/title=Emonoda ({source})`**
    * Заголовок оповещения.

* **`confetti/pushover/template=""`**
    * Путь к mako-шаблону для форматирования сообщений. Если не указан, используется встроенный.

* **`confetti/pushover/statuses=[invalid, not_in_client, tracker_error, unhandled_error, affected]`**
    * Типы сообщений о результатах обновления, которые необходимо отправить (в порядке отправки).

* **`confetti/pushover/proxy_url=""`**
    * Прокси до сервиса. Поддерживаются HTTP-прокси и SOCKS4/5. Этот параметр можно использовать так: `trackers/rutracker.org/proxy_url=socks5://localhost:5000` (вместе с [SOCKS-проксированием по SSH](https://ru.wikibooks.org/wiki/SSH_%D1%82%D1%83%D0%BD%D0%BD%D0%B5%D0%BB%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5)). Формат - `scheme://username:passwd@host:port`. Вместо `scheme` нужно указать `socks4`, `socks5` или `http`.

* **`confetti/pushover/timeout=10.0`**
    * Сетевой таймаут в секундах.

* **`confetti/pushover/retries=5`**
    * Количество попыток повторной отправки оповещений в случае ошибки сети или сервера.

* **`confetti/pushover/retries_sleep=1.0`**
    * Пауза в секундах между попытками отправки оповещений.


***
#### Уведомление в сети чатов Matrix

Включаются плагином `matrix`. Для отправки уведомлений используется API.

!!! warning
    * Для работы плагина необходим питоновый модуль [`matrix-nio`](https://matrix-nio.readthedocs.io/en/latest/#installation)
    * End-to-end шифрование плагином **не** поддерживается!

1. Чтобы отправлять себе сообщения, необходимо зарегистрировать аккаунт, от лица которого они будут отправляться. Для примера - вы создали пользователя `@emonoda:some.example.com` - имя пользователя `emonoda` на homeserver'е `some.example.com` - c паролём `very[in]S1cureP@ss`.
2. После регистрации зайдите в созданный аккаунт через клиент (например - в [этот](https://riot.im/app) в приватной вкладке браузера).
3. Пригласите необходимые аккаунты (свои и/или чужие) к чату, примите соотвествующие приглашения.
4. Для каждого чата, в который вы хотите посылать уведомления, запишите внутренний идентификатор чата (Он будет вида `!SomELoNgLEtteRsSeq:some.example.org`).

Пример конфигурации с использованием параметров, перечисленных выше:

```yaml
confetti:
    matrix:
        homeserver_url: 'some.example.com'
        user: '@emonoda:some.example.com'
        passwd: 'very[in]S1cureP@ss'
        room_ids:
            - '!SomELoNgLEtteRsSeq:some.example.org'
```

!!! warning
    Обратите внимание, что некоторые параметры содержат символ двоеточия **`:`**, который является элементом синтаксиса в `YAML`. Потому все значения с этим символом должны быть в кавычках - пример: `user: '@emonoda:some.example.com'`.

Параметры конфигурации:

* **`confetti/matrix/homeserver_url=https://matrix.org`**
    * Адрес homeserver, через который вы будете работать с сетью Matrix.

* **`confetti/matrix/user=CHANGE_ME`**
    * Имя пользователя от имени которого будут отправляться уведомления. **Должно** быть в форме **`@somename:example.com`**

* **`confetti/matrix/passwd=CHANGE_ME`**
    * Пароль для этого имени пользователя

* **`confetti/matrix/room_ids=[]`**
    * Идентификаторы комнат, в которые будут отправляться уведомления. **Должны** быть в форме **`!SomELoNgLEtteRsSeq:some.example.org`**

* **`confetti/matrix/template=''`**
    * Путь к mako-шаблону для форматирования сообщений. Если не указан, используется встроенный.

* **`confetti/matrix/statuses=[invalid, not_in_client, tracker_error, unhandled_error, affected]`**
    * Типы сообщений о результатах обновления, которые необходимо отправить (в порядке отправки).


***
#### Лента Atom для использования на сервере

Для полноценного использования этой опции необходимо, чтобы на компьютере, с которого запускается **Emonoda** был запущен любой веб-сервер. Подойдёт, например, встроенный в Python простейший сервер:

```
$ python -m http.server
Serving HTTP on 0.0.0.0 port 8000 (http://0.0.0.0:8000/) ...
```

Для более полноценной работы рекомендуется использовать полноценный сервер (nginx, lighttpd и т.д.). Его необходимо настроить так, чтобы он отдавал файл с лентой по адресу, который вы указываете в параметре `confetti/atom/url`. По умолчанию плагин хранит максимум 20 последних обновлений, на основе которых создаётся файл ленты. После создания файла ленты плагин назначит ему права `664`, чтобы в дальнейшем иметь возможность редактировать этот файл.

* **`confetti/atom/history_path=emonoda_history.yaml`**
    * Имя файла с полным путём до файла, в котором хранится история обновлений.

* **`confetti/atom/path=atom.xml`**
    * Путь до места хранения ленты.

* **`confetti/atom/url=http://localhost`**
    * Полная ссылка на файл ленты в соответствии со ссылкой, по которой она будет доступна с сервера.

* **`confetti/atom/user=""`**
    * Пользователь, во владение которого плагин передаст ленту.

* **`confetti/atom/group=""`**
    * Группа пользователей, во владение которой плагин передаст ленту. Если пользователь, от имени которого запущена **Emonoda**, не состоит в этой группе, то плагин выдаст ошибку.

* **`confetti/atom/template=""`**
    * Шаблон для форматирования ленты. Если не указан, используется встроенный.

* **`confetti/atom/html=true`**
    * Выбор вида заготовки для электнов ленты. По умолчанию они форматируется в HTML, иначе - в виде плейнтекста.


***
### Тестирование оповещений

После настройки всех оповещений вы можете протестировать их с помощью команды [emconfetti-demo](/emconfetti-demo). Данная команда генерирует демо-сообщения и отсылает их всеми способами, указанными в секции `confetti`.
